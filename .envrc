#### GENERAL SETUP ####
export PROJECT_ROOT=$(git rev-parse --show-toplevel)

# Source and watch the .env file:
dotenv
watch_file .env

#### LOAD NIX ENVIRONMENT ####

# Allow unfree packages (for closed-source VS Code extensions):
export NIXPKGS_ALLOW_UNFREE=1

# Disable Boehm garbage collection on Macs to prevent seg-fault
if [[ "$(uname)" == "Darwin" ]]; then
    export GC_DONT_GC=1
fi


# https://github.com/nix-community/nix-direnv A fast, persistent use_nix/use_flake implementation for direnv:
if ! has nix_direnv_version || ! nix_direnv_version 3.0.6; then
    source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.6/direnvrc" "sha256-RYcUJaRMf8oF5LznDrlCXbkOQrywm0HDv1VjYGaJGdM="
fi


PATH_add .cabal/bin

if use flake "github:input-output-hk/devx?rev=d316c0394de3c72abd2d79d1b55a3b6abc9d0f0c#ghc96-iog-full"; then
    export DEV_ENV_LOADED=true

    # Build cabal project locally
    export CABAL_DIR="$PROJECT_ROOT/.cabal"

    # Create symlink to Nix HLS binary (prevents conflict with GHCup binaries)
    just link-hls

    # Fix for liblzma - comprehensive solution
    export PKG_CONFIG_PATH="$(nix eval --raw nixpkgs#xz.dev)/lib/pkgconfig:$(nix eval --raw nixpkgs#xz)/lib/pkgconfig:$PKG_CONFIG_PATH"
    export PKG_CONFIG_PATH_FOR_TARGET="$(nix eval --raw nixpkgs#xz.dev)/lib/pkgconfig:$(nix eval --raw nixpkgs#xz)/lib/pkgconfig:$PKG_CONFIG_PATH_FOR_TARGET"
    
    # Also add liblzma library paths
    export LIBRARY_PATH="$(nix eval --raw nixpkgs#xz)/lib:$LIBRARY_PATH"
    export LD_LIBRARY_PATH="$(nix eval --raw nixpkgs#xz)/lib:$LD_LIBRARY_PATH"
    
    # Verify liblzma is available
    if pkg-config --modversion liblzma >/dev/null 2>&1; then
        echo "✓ liblzma found: $(pkg-config --modversion liblzma)"
    else
        echo "⚠ Warning: liblzma still not found by pkg-config"
        echo "  PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
    fi

    echo "DevX environment loaded successfully"
else
    echo "Error loading the environment!"
    exit 1
fi